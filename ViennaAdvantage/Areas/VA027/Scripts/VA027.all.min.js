/*Version 1.0.18.0*/VA027=window.VA027||{},function(n){function i(){VIS.CalloutEngine.call(this,"VA027.VA027_CalloutPostPayment")}var r=VIS.Logging.Level,t=VIS.Utility.Util;VIS.Utility.inheritPrototype(i,VIS.CalloutEngine);i.prototype.Order=function(n,t,i,u,f,e){var s,h,o;if(f==null||f.toString()==""||(s=f,this.isCalloutActive()||s==null||s==0))return"";this.setCalloutActive(!0);i.setValue("C_Invoice_ID",null);i.setValue("C_Charge_ID",null);i.setValue("VA027_IsPrepayment",!0);i.setValue("VA027_DiscountAmt",VIS.Env.ZERO);i.setValue("VA027_WriteoffAmt",VIS.Env.ZERO);h="";o=null;try{h="C_Order,"+f.toString();o=VIS.dataContext.getJSONRecord("PDC/GetBPData",h);o!=null&&(i.setValue("C_Bpartner_ID",o.C_BPartner_ID),i.setValue("C_Bpartner_Location_ID",o.C_BPartner_Location_ID))}catch(c){return o!=null&&(o.close(),o=null),this.log.log(r.SEVERE,sql,c),this.setCalloutActive(!1),c.message}this.setCalloutActive(!1);n=t=i=u=f=e=null};i.prototype.BPartner=function(n,i,r,u,f){var e,s,o;if(this.isCalloutActive()||f==null||f.toString()=="")return"";if(this.setCalloutActive(!0),e=t.getValueOfInt(r.getValue("C_BPartner_ID")),e!=0)try{s="SELECT VA009_PAYMENTMETHOD_ID FROM C_BPARTNER WHERE C_BPARTNER_ID="+e;o=VIS.DB.executeDataSet(s);o.getTables()[0].getRows().length>0&&r.setValue("VA009_PAYMENTMETHOD_ID",t.getValueOfInt(o.getTables()[0].getRows()[0].getCell("va009_paymentmethod_id")))}catch(h){this.log.severe(h.toString())}return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""};i.prototype.OrderPaySchedule=function(n,i,r,u,f){var o,s,e;if(this.isCalloutActive()||f==null||f.toString()=="")return t.getValueOfInt(r.getValue("VA009_ORDERPAYSCHEDULE_ID"))==null||t.getValueOfInt(r.getValue("VA009_ORDERPAYSCHEDULE_ID"))==0?(r.setValue("VA027_PayAmt",0),this.setCalloutActive(!1),""):"";if(this.setCalloutActive(!0),o=t.getValueOfInt(r.getValue("VA009_ORDERPAYSCHEDULE_ID")),o!=0)try{if(s="SELECT VA009_PAYMENTMETHOD_ID,DUEAMT,DUEDATE,DISCOUNTAMT,C_BPARTNER_ID FROM VA009_ORDERPAYSCHEDULE WHERE VA009_ORDERPAYSCHEDULE_ID="+o,e=VIS.DB.executeDataSet(s),e.getTables()[0].getRows().length>0){var h=0,l=t.getValueOfDecimal(e.getTables()[0].getRows()[0].getCell("dueamt")),c=t.getValueOfDecimal(e.getTables()[0].getRows()[0].getCell("discountamt"));h=l-c;r.setValue("VA027_PayAmt",h);r.setValue("VA009_PAYMENTMETHOD_ID",t.getValueOfInt(e.getTables()[0].getRows()[0].getCell("va009_paymentmethod_id")));r.setValue("VA027_DISCOUNTAMT",c);r.setValue("VA027_TRXDATE",t.getValueOfDate(e.getTables()[0].getRows()[0].getCell("duedate")));r.setValue("DateAcct",t.getValueOfDate(e.getTables()[0].getRows()[0].getCell("duedate")))}}catch(a){this.log.severe(a.toString())}return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""};i.prototype.InvoicePaySchedule=function(n,i,r,u,f){var o,s,h,e;if(this.isCalloutActive()||f==null||f.toString()=="")return t.getValueOfInt(r.getValue("C_INVOICEPAYSCHEDULE_ID"))==null||t.getValueOfInt(r.getValue("C_INVOICEPAYSCHEDULE_ID"))==0?(r.setValue("VA027_PayAmt",0),this.setCalloutActive(!1),""):"";if(this.setCalloutActive(!0),o=t.getValueOfInt(r.getValue("C_INVOICEPAYSCHEDULE_ID")),o==null||o==0)return r.setValue("VA027_PayAmt",0),this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,"";s=t.getValueOfInt(r.getValue("C_BPARTNER_ID"));try{if(o!=0&&s!=0&&(h="SELECT VA009_PAYMENTMETHOD_ID,DUEAMT,DUEDATE,DISCOUNTAMT,C_BPARTNER_ID FROM C_INVOICEPAYSCHEDULE WHERE C_INVOICEPAYSCHEDULE_ID="+o,e=VIS.DB.executeDataSet(h),e.getTables()[0].getRows().length>0)){var c=0,a=t.getValueOfDecimal(e.getTables()[0].getRows()[0].getCell("dueamt")),l=t.getValueOfDecimal(e.getTables()[0].getRows()[0].getCell("discountamt"));c=a-l;r.setValue("VA027_PayAmt",c);r.setValue("VA009_PAYMENTMETHOD_ID",t.getValueOfInt(e.getTables()[0].getRows()[0].getCell("va009_paymentmethod_id")));r.setValue("VA027_DISCOUNTAMT",l);r.setValue("VA027_TRXDATE",t.getValueOfDate(e.getTables()[0].getRows()[0].getCell("duedate")));r.setValue("DateAcct",t.getValueOfDate(e.getTables()[0].getRows()[0].getCell("duedate")))}}catch(v){this.log.severe(v.toString())}return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""};i.prototype.InvoicePayScheduleAmount=function(n,i,r,u,f){if(this.isCalloutActive()||f==null||f.toString()=="")return t.getValueOfInt(r.getValue("C_INVOICEPAYSCHEDULE_ID"))==0?(r.setValue("Amount",0),""):"";this.setCalloutActive(!0);var h=null,e=0,c=u.getColumnName(),l="",a=t.getValueOfInt(r.getValue("C_INVOICEPAYSCHEDULE_ID")),o=t.getValueOfDecimal(r.getValue("WriteOffAmt")==null?VIS.Env.ZERO:r.getValue("WriteOffAmt")),s=t.getValueOfDecimal(r.getValue("DiscountAmt")==null?VIS.Env.ZERO:r.getValue("DiscountAmt")),v=t.getValueOfDecimal(r.getValue("Amount")==null?VIS.Env.ZERO:r.getValue("Amount"));try{a!=0&&(h=VIS.dataContext.getJSONRecord("PDC/GetInvoicePayscheduleData",a.toString()),h!=null&&(e=t.getValueOfDecimal(h.DueAmt),r.setValue("InvoiceAmt",e),r.setValue("Amount",e),l=t.getValueOfString(h.IsReturnTrx),"Y"==l&&(e>0&&(e=e*-1,r.setValue("InvoiceAmt",e),r.setValue("Amount",e)),o>0&&(o=o*-1,r.setValue("WriteOffAmt",o)),s>0&&(s=s*-1,r.setValue("DiscountAmt",s)))));(c.equals("WriteOffAmt")||c.equals("DiscountAmt")||c.equals("Amount"))&&(v=e-s-o,r.setValue("Amount",v))}catch(y){return this.log.severe(y.toString()),this.setCalloutActive(!1),y.message}return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""};i.prototype.WriteOffAmt=function(n,i,r,u,f){if(this.isCalloutActive()||f==null||f.toString()=="")return"";this.setCalloutActive(!0);var o=t.getValueOfInt(r.getValue("VA009_OrderPaySchedule_ID")),s=t.getValueOfInt(r.getValue("C_INVOICEPAYSCHEDULE_ID")),c=t.getValueOfInt(r.getValue("VA027_WriteoffAmt")),l=t.getValueOfDecimal(r.getValue("VA027_DiscountAmt")),e=0;try{s!=0&&(dr=VIS.dataContext.getJSONRecord("PDC/GetInvoicePayscheduleData",s.toString()),dr!=null&&(e=t.getValueOfDecimal(dr.DueAmt)));o!=0&&(dr=VIS.dataContext.getJSONRecord("PDC/GetOrderPayScheduleData",o.toString()),dr!=null&&(e=t.getValueOfDecimal(dr.DueAmt)));r.setValue("VA027_PayAmt",e-l-c)}catch(h){return this.log.severe(h.toString()),this.setCalloutActive(!1),h.message}return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""};i.prototype.DocType=function(n,i,r,u,f){if(this.isCalloutActive()||f==null||f.toString()=="")return"";this.setCalloutActive(!0);var a=t.getValueOfInt(r.getValue("C_Invoice_ID")),v=t.getValueOfInt(r.getValue("C_Order_ID")),s="",o="",e=null,l=t.getValueOfInt(r.getValue("C_DocType_ID"));if(l>0&&(e=VIS.dataContext.getJSONRecord("PDC/GetDocBaseType","C_DocType,"+l.toString()),e!=null&&(s=e.DocBaseType,s=="PDP"?r.setValue("IsSOTrx","N"):s=="PDR"&&r.setValue("IsSOTrx","Y"))),a!=0&&(e=VIS.dataContext.getJSONRecord("PDC/GetDocBaseType","C_Invoice,"+a.toString()),e!=null&&((o=e.DocBaseType,(o=="ARI"||o=="ARC")&&s=="PDP")||(o=="API"||o=="APC")&&s=="PDR")))return this.setCalloutActive(!1),"VA027_PaymentDocTypeInvoiceInconsistent";if(v!=0&&(e=VIS.dataContext.getJSONRecord("PDC/GetDocBaseType","C_Order,"+v.toString()),e!=null)){var h=e.IsSOTrx=="Y",c=e.IsReturnTrx=="Y",y=e.GrandTotal;if(o=e.DocBaseType,l>0)if(o=="SOO"&&h&&!c){if(s=="PDP")return this.setCalloutActive(!1),"VA027_PaymentDocTypeInvoiceInconsistent"}else if(o=="SOO"&&h&&c){if(s=="PDP")return this.setCalloutActive(!1),"VA027_PaymentDocTypeInvoiceInconsistent";r.setValue("VA027_PayAmt",-Math.abs(y))}else if(o!="POO"||h||c){if(o=="POO"&&!h&&c)if(s=="PDP")r.setValue("VA027_PayAmt",-Math.abs(y));else return this.setCalloutActive(!1),"VA027_PaymentDocTypeInvoiceInconsistent"}else if(s=="PDR")return this.setCalloutActive(!1),"VA027_PaymentDocTypeInvoiceInconsistent"}return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""};i.prototype.TrxDate=function(n,i,r,u,f){var c;if(this.isCalloutActive()||f==null||f.toString()=="")return"";this.setCalloutActive(!0);var o=t.getValueOfDate(r.getValue("VA027_TrxDate")),h=t.getValueOfInt(r.getValue("VA009_ORDERPAYSCHEDULE_ID")),a=t.getValueOfInt(r.getValue("C_INVOICEPAYSCHEDULE_ID"));if(h!=0||a!=0){try{c=h>0?"SELECT VA009_PAYMENTMETHOD_ID,DUEAMT,DUEDATE,DISCOUNTDATE,DISCOUNTAMT,DISCOUNTDAYS2,DISCOUNT2 FROM VA009_ORDERPAYSCHEDULE WHERE VA009_ORDERPAYSCHEDULE_ID="+h:"SELECT VA009_PAYMENTMETHOD_ID, DUEAMT, DUEDATE, DISCOUNTDATE, DISCOUNTAMT, DISCOUNTDAYS2, DISCOUNT2 FROM C_INVOICEPAYSCHEDULE WHERE C_INVOICEPAYSCHEDULE_ID="+a;var e=VIS.DB.executeDataSet(c),s=0,l=t.getValueOfDecimal(e.getTables()[0].getRows()[0].getCell("dueamt")),v=t.getValueOfDecimal(e.getTables()[0].getRows()[0].getCell("discountamt")),y=t.getValueOfDecimal(e.getTables()[0].getRows()[0].getCell("discount2")),p=t.getValueOfDate(e.getTables()[0].getRows()[0].getCell("discountdate")),w=t.getValueOfDate(e.getTables()[0].getRows()[0].getCell("discountdays2"));o<=p?(s=l-v,r.setValue("VA027_PayAmt",s),r.setValue("VA027_DiscountAmt",v)):o<=w?(s=l-y,r.setValue("VA027_PayAmt",s),r.setValue("VA027_DiscountAmt",y)):(o>p||o>w)&&(r.setValue("VA027_PayAmt",l),r.setValue("VA027_DiscountAmt",VIS.Env.ZERO))}catch(b){this.log.severe(b.toString())}return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""}return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""};i.prototype.PaymentTaxAmount=function(n,i,r,u,f,e){var l,c,o,s,h;if(this.isCalloutActive()||f==null||f.toString()=="")return"";this.setCalloutActive(!0);try{if(l=VIS.dataContext.getJSONRecord("MCurrency/GetCurrency",r.getValue("C_Currency_ID").toString()),c=l.StdPrecision,u.getColumnName()=="C_Tax_ID")if(t.getValueOfDecimal(r.getValue("VA027_PayAmt"))>0){if(o=null,r.getField("SurchargeAmt")!=null)return o=VIS.dataContext.getJSONRecord("MTax/CalculateSurcharge",f.toString()+","+r.getValue("VA027_PayAmt").toString()+","+c.toString()),r.setValue("TaxAmount",o.TaxAmt),r.setValue("SurchargeAmt",o.SurchargeAmt),this.setCalloutActive(!1),"";if(s=VIS.dataContext.getJSONRecord("MTax/GetTaxRate",f.toString()),s>0)h=t.getValueOfDecimal(t.getValueOfDecimal(r.getValue("VA027_PayAmt"))-t.getValueOfDecimal(r.getValue("VA027_PayAmt"))/(s/100+1)),r.setValue("TaxAmount",t.getValueOfDecimal(h.toFixed(2)));else return r.setValue("TaxAmount",0),this.setCalloutActive(!1),""}else return this.setCalloutActive(!1),"";else if(t.getValueOfInt(r.getValue("C_Tax_ID"))>0){if(o=null,r.getField("SurchargeAmt")!=null)return o=VIS.dataContext.getJSONRecord("MTax/CalculateSurcharge",r.getValue("C_Tax_ID").toString()+","+r.getValue("VA027_PayAmt").toString()+","+c.toString()),r.setValue("TaxAmount",o.TaxAmt),r.setValue("SurchargeAmt",o.SurchargeAmt),this.setCalloutActive(!1),"";if(s=VIS.dataContext.getJSONRecord("MTax/GetTaxRate",r.getValue("C_Tax_ID").toString()),s>0)h=t.getValueOfDecimal(t.getValueOfDecimal(r.getValue("VA027_PayAmt"))-t.getValueOfDecimal(r.getValue("VA027_PayAmt"))/(s/100+1)),r.setValue("TaxAmount",t.getValueOfDecimal(h.toFixed(2)));else return r.setValue("TaxAmount",0),this.setCalloutActive(!1),""}else return this.setCalloutActive(!1),""}catch(a){this.setCalloutActive(!1);this.log.severe(a.toString())}return this.setCalloutActive(!1),n=i=r=u=f=e=null,""};i.prototype.BusinessPartner=function(n,t,i,r,u){if(this.isCalloutActive()||u==null||u.toString()=="")return"";this.setCalloutActive(!0);try{var f=null,e="",o=r.getColumnName();i.getValue("C_Bpartner_ID")==null&&(e="C_Invoice,"+u.toString(),f=VIS.dataContext.getJSONRecord("PDC/GetBPData",e),f!=null&&(i.setValue("C_Bpartner_ID",f.C_BPartner_ID),i.setValue("C_Bpartner_Location_ID",f.C_BPartner_Location_ID)));o.equals("C_BPartner_ID")&&(e="C_BPartner,"+u.toString(),f=VIS.dataContext.getJSONRecord("PDC/GetBPData",e),f!=null&&i.setValue("C_Bpartner_Location_ID",f.C_BPartner_Location_ID))}catch(s){this.log.severe(s.toString())}return this.setCalloutActive(!1),n=t=i=r=u=oldvalue=null,""};i.prototype.PayAmtNull=function(n,t,i,r,u){if(this.isCalloutActive()||u==null||u.toString()=="")return"";this.setCalloutActive(!0);try{i.getValue("PDCType")=="D"&&(i.setValue("VA027_PayAmt",0),i.setValue("C_Bpartner_ID",null),i.setValue("C_Bpartner_Location_ID",null),i.setValue("C_Invoice_ID",null),i.setValue("C_Order_ID",null))}catch(f){this.log.severe(f.toString())}return this.setCalloutActive(!1),n=t=i=r=u=oldvalue=null,""};i.prototype.SetConvAmt=function(n,i,r,u,f){var w,y,k,o,s;if(this.isCalloutActive()||f==null||f.toString()=="")return"";this.setCalloutActive(!0);var g=u.getColumnName(),c=r.getValue("C_Invoice_ID"),p=r.getValue("C_Order_ID"),a=0,l=VIS.Env.ZERO,v="";if(c==null&&p==null)return this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,"";var b=r.getValue("C_Currency_ID"),e=null;try{c!=""?(w=0,n.getContextAsInt(i,"C_Invoice_ID")==c&&r.getValue("C_InvoicePaySchedule_ID")!=null&&(w=r.getValue("C_InvoicePaySchedule_ID")),y=r.getValue("DateTrx"),y==null&&(y=new Date),l=r.getValue("VA027_PayAmt"),paramString=c.toString()+","+w.toString()+","+y.toString(),o=VIS.dataContext.getJSONRecord("MPayment/GetInvoiceData",paramString),o!=null&&(e=t.getValueOfInt(o.C_Currency_ID),a=t.getValueOfInt(o.C_ConversionType_ID))):(k=n.getContextAsInt(i,"VA009_OrderPaySchedule_ID"),l=r.getValue("VA027_PayAmt"),v=p.toString()+","+r.getValue("DateTrx").toString()+","+k.toString(),o=VIS.dataContext.getJSONRecord("PDC/GetOrderData",v),o!=null&&(e=o.C_Currency_ID,a=o.C_ConversionType_ID));s=t.getValueOfInt(b);paramString=s.toString();var nt=VIS.dataContext.getJSONRecord("MCurrency/GetCurrency",paramString),tt=nt.StdPrecision,d=r.getValue("DateTrx"),it=n.getContextAsInt(i,"AD_Client_ID"),rt=n.getContextAsInt(i,"AD_Org_ID"),h=VIS.Env.ONE;if(e==b)r.setValue("CurrencyRate",h),r.setValue("VA027_ConvertedAmount",r.getValue("VA027_PayAmt"));else if(s>0&&e>0&&s!=e||g=="C_Currency_ID"){if(this.log.fine("Currency To="+e+", Currency From="+s+", Date="+d+", Type="+a),v=e+","+s+","+d+","+a+","+it+","+rt,h=VIS.dataContext.getJSONRecord("MConversionRate/GetRate",v),h==null||h.toString()==0)return e==0?"":(this.setCalloutActive(!1),r.setValue("C_Currency_ID",e),"NoCurrencyConversion");r.setValue("CurrencyRate",h);l=t.getValueOfDecimal((l*h).toFixed(tt));r.setValue("VA027_ConvertedAmount",l)}}catch(ut){this.log.severe(ut.toString())}return c=p=null,this.setCalloutActive(!1),n=i=r=u=f=oldvalue=null,""};i.prototype.BankAccount=function(n,i,r,u,f,e){var o,s;if(this.isCalloutActive()||f==null||f.toString()=="")return"";this.setCalloutActive(!0);o=f;try{s=t.getValueOfInt(VIS.dataContext.getJSONRecord("PDC/GetBankAcctCurrency",o.toString()));r.setValue("C_Currency_ID",s)}catch(h){return this.log.severe(h.toString()),this.setCalloutActive(!1),h.message}return this.setCalloutActive(!1),n=r=u=f=e=null,""};n.Model=n.Model||{};n.Model.VA027_CalloutPostPayment=i}(VA027,jQuery)